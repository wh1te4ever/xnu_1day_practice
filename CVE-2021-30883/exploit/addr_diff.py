#!/usr/bin/env python3
# addr_diff.py
# 파일을 읽어 콜론(:) 이후의 0x... 값들을 추출하고 0은 스킵한 뒤
# 연속으로 등장하는 주소 쌍의 차이를 출력합니다.

import sys
import re

HEX_RE = re.compile(r'0x[0-9a-fA-F]+')

def extract_values_from_line(line):
    """라인에서 ':' 이후 부분만 보고 0x... 토큰을 찾아 정수로 반환"""
    if ':' not in line:
        return []
    _, right = line.split(':', 1)
    toks = HEX_RE.findall(right)
    vals = []
    for t in toks:
        try:
            v = int(t, 16)
        except ValueError:
            continue
        if v != 0:
            vals.append(v)
    return vals

def read_addresses(filename):
    """파일 전체를 스캔해 등장 순서대로 0이 아닌 0x값들을 리스트로 반환"""
    res = []
    with open(filename, 'r', encoding='utf-8', errors='ignore') as f:
        for line in f:
            line = line.strip()
            if not line:
                continue
            vals = extract_values_from_line(line)
            if vals:
                res.extend(vals)
    return res

def print_differences(addrs, absolute=False):
    """연속 쌍별로 차이를 출력"""
    if len(addrs) < 2:
        print("충분한 주소가 없습니다.")
        return
    for i in range(len(addrs) - 1):
        a = addrs[i]
        b = addrs[i+1]
        diff = b - a
        if absolute:
            diff = abs(diff)
        print(f"{i:04d}: {hex(a)}  ->  {hex(b)}    diff = {hex(diff)} ({diff})")

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 addr_diff.py hexdump.txt")
        sys.exit(1)
    filename = sys.argv[1]
    addrs = read_addresses(filename)
    if not addrs:
        print("파일에서 유효한 주소(0x...)를 찾지 못했습니다.")
        sys.exit(1)

    print(f"총 주소 개수: {len(addrs)} (0은 스킵됨)")
    # 기본은 signed difference (b - a). 절대값 원하면 absolute=True로 설정
    print_differences(addrs, absolute=False)

if __name__ == "__main__":
    main()
