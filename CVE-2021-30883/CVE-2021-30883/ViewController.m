//
//  ViewController.m
//  CVE-2021-30883
//
//  Created by seo on 11/27/25.
//

#import "ViewController.h"
#import "exploit.h"
#import <sys/sysctl.h>

char *gOsProductVersion;
char *gOsVersion;
char *gHwModel;
char* gModelName;
char* gKernVersion;

id gViewController;

@interface ViewController ()
@property(strong, nonatomic) IBOutlet UITextView *logView;
- (IBAction)exploitBtn:(UIButton *)sender;
@end

void printLog(const char *format, ...) {
    char __str[1024];
    va_list args;
    va_start(args, format);
    vsnprintf(__str, sizeof(__str), format, args);
    va_end(args);

    NSString *logMessage = [NSString stringWithCString:__str encoding:NSASCIIStringEncoding];
    NSString *formattedMessage = [NSString stringWithFormat:@"%@", logMessage];
    printf("%s\n", formattedMessage.UTF8String);

    dispatch_async(dispatch_get_main_queue(), ^{
//      NSLog(@"%@", formattedMessage);

      UITextView *logView = [gViewController logView];

      NSString *currentText = [logView text];
      NSString *newText = [currentText stringByAppendingString:formattedMessage];
      [logView setText:newText];

      NSRange range = NSMakeRange([newText length], 0);
      [logView scrollRangeToVisible:range];
    });
}

@implementation ViewController

- (void)viewDidLoad {
    [super viewDidLoad];

    gViewController = self;
    // Do any additional setup after loading the view.

    int err;
    char buf[256];
    size_t bufLen;

    bufLen = sizeof(buf);
    err = sysctlbyname("kern.osproductversion", buf, &bufLen, NULL, 0);
    gOsProductVersion = strdup(buf);

    bufLen = sizeof(buf);
    err = sysctlbyname("kern.osversion", buf, &bufLen, NULL, 0);
    gOsVersion = strdup(buf);

    bufLen = sizeof(buf);
    err = sysctlbyname("hw.model", buf, &bufLen, NULL, 0);
    gHwModel = strdup(buf);

    bufLen = sizeof(buf);
    err = sysctlbyname("kern.version", buf, &bufLen, NULL, 0);
    gKernVersion = strdup(buf);

    printLog("[*] System Version: iOS %s (%s)\n", gOsProductVersion, gOsVersion);
    printLog("[*] Model Name: %s\n", gHwModel);
    printLog("[*] Kernel Version: %s\n", gKernVersion);
}

- (IBAction)exploitBtn:(UIButton *)sender {
    exploit();
}
@end
