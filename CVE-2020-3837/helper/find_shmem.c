#include "offsets.h"
#include "kexecute.h"
#include "find_shmem.h"
#include "find_port.h"
#include "kutils.h"
#include "krw.h"

#include "../print.h"

void find_shmem_in_kernel(uint64_t *kva1, uint64_t *kva2, uint64_t command_buffer_shmem_sig, uint64_t segment_list_shmem_sig) {
    uint64_t command_buffer_shmem_data_kva = 0;
	uint64_t segment_list_shmem_data_kva = 0;
	uint64_t gIOKitPageableSpace_start = kread64(ksym(KSYMBOL_gIOKitPageableSpace) + 0x10);
	uint64_t gIOKitPageableSpace_end = kread64(ksym(KSYMBOL_gIOKitPageableSpace) + 0x18);
	INFO("gIOKitPageableSpace_start: 0x%llx, gIOKitPageableSpace_end: 0x%llx\n", gIOKitPageableSpace_start, gIOKitPageableSpace_end);

	int i = 0;

	while(1) {
		uint64_t current_kva = gIOKitPageableSpace_start + i * 0x1000;

		if(i > 0x10000000) break;

		//check if valid readable kernel address to prevent kernel panic
		uint64_t current_pa = kvtophys(current_kva);
		if(current_pa == 0) continue;

		if(physread64(current_pa) == command_buffer_shmem_sig) {
			INFO("Found command_buffer_shmem in kernel: 0x%llx\n", current_kva-0x1000);
			command_buffer_shmem_data_kva = current_kva-0x1000;
            *kva1 = command_buffer_shmem_data_kva;
		}

		if(physread64(current_pa) == segment_list_shmem_sig) {
			INFO("Found segment_list_shmem in kernel: 0x%llx\n", current_kva-0x1000);
			segment_list_shmem_data_kva = current_kva-0x1000;
            *kva2 = segment_list_shmem_data_kva;
		}

		if(segment_list_shmem_data_kva && command_buffer_shmem_data_kva) break;

		i++;
	}
}