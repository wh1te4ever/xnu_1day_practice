#include "ioaccel.h"
#include "iokit.h"

io_connect_t IOAccelDevice2Conn = IO_OBJECT_NULL;
io_connect_t IOAccelContext2Client = IO_OBJECT_NULL;
io_service_t IOGraphicsAccelerator2;

kern_return_t IOAccelCommandQueue2_set_notification_port(mach_port_t notification_port) {
    return IOConnectCallAsyncMethod(IOAccelDevice2Conn, IOAccelCommandQueue2_set_notification_port_selector, notification_port, NULL, 0, NULL, 0, NULL, 0, NULL, NULL, NULL, NULL);
}

int IOAccelerator_init() {
    IOGraphicsAccelerator2 = IOServiceGetMatchingService(kIOMasterPortDefault, IOServiceMatching("IOGraphicsAccelerator2"));
    if (!IOGraphicsAccelerator2) {
        printf("[-] Failed to find IOGraphicsAccelerator2 service\n");
        return KERN_FAILURE;
    }

    kern_return_t kr = IOServiceOpen(IOGraphicsAccelerator2, mach_task_self(), kIOAccelDevice2Type, &IOAccelDevice2Conn);
    if (kr) {
        printf("[-] Failed to open IOAccelDevice2Conn: 0x%x (%s)\n", kr, mach_error_string(kr));
        return kr;
    }

    kr = IOServiceOpen(IOGraphicsAccelerator2, mach_task_self(),
            kIOAccelContext2Type, &IOAccelContext2Client);
    if (kr) {
        printf("[-] Failed to open IOAccelContext2Client: 0x%x (%s)\n", kr, mach_error_string(kr));
        return kr;
    }
    
    kr = IOConnectAddClient(IOAccelDevice2Conn, IOAccelContext2Client);
    if (kr) {
        printf("[-] Failed to connect IOAccelDevice2Conn to IOAccelContext2Client: 0x%x (%s)\n", kr, mach_error_string(kr));
        return kr;
    }

    mach_port_t notification_port;
    mach_port_allocate(mach_task_self(), MACH_PORT_RIGHT_RECEIVE, &notification_port);
    IOAccelCommandQueue2_set_notification_port(notification_port);
    
    return 0;
}

void IOAccelerator_deinit() {
    if (IOGraphicsAccelerator2) IOObjectRelease(IOGraphicsAccelerator2);
    if (IOAccelDevice2Conn) IOServiceClose(IOAccelDevice2Conn);
    if (IOAccelContext2Client) IOServiceClose(IOAccelContext2Client);
    
    IOGraphicsAccelerator2 = 0;
    IOAccelDevice2Conn = 0;
    IOAccelContext2Client = 0;
}