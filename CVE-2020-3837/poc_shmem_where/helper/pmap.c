#include "krw.h"
#include "offsets.h"
#include "physrw.h"
#include "pmap.h"
#include "physrw.h"
#include "translation.h"
// #include "kfunc.h"
#include "pte.h"
#include "pvh.h"

#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>

vm_size_t get_kernel_page_size() {
    vm_size_t kernel_page_size = 0;
    vm_size_t *out_page_size = NULL;
    host_t host = mach_host_self();
    if (!MACH_PORT_VALID(host)) goto out;
    out_page_size = (vm_size_t *)malloc(sizeof(vm_size_t));
    if (out_page_size == NULL) goto out;
    bzero(out_page_size, sizeof(vm_size_t));
    if (_host_page_size(host, out_page_size) != KERN_SUCCESS) goto out;
    kernel_page_size = *out_page_size;
out:
    if (MACH_PORT_VALID(host)) mach_port_deallocate(mach_task_self(), host); host = HOST_NULL;
    if(out_page_size != NULL) free(out_page_size);
    return kernel_page_size;
}

uint64_t get_l1_block_size(void)
{
	switch (vm_real_kernel_page_size) {
		case 0x4000:
		    return 0x1000000000;
		case 0x1000:
		    return 0x40000000;
		default:
		    return 0;
	}
}

uint64_t get_l1_block_mask(void)
{
	return get_l1_block_size() - 1;
}

uint64_t get_l1_block_count(void)
{
	switch (vm_real_kernel_page_size) {
		case 0x4000:
		    return 8;
		case 0x1000:
		    return 256;
		default:
		    return 0;
	}
}

uint64_t get_l2_block_size(void)
{
	switch (vm_real_kernel_page_size) {
		case 0x4000:
		    return 0x2000000;
		case 0x1000:
		    return 0x200000;
		default:
		    return 0;
	}
}

uint64_t get_l2_block_mask(void)
{
	return get_l2_block_size() - 1;
}

uint64_t get_l2_block_count(void)
{
	switch (vm_real_kernel_page_size) {
		case 0x4000:
		    return 2048;
		case 0x1000:
		    return 512;
		default:
		    return 0;
	}
}

#define atop(x) ((vm_address_t)(x) >> vm_kernel_page_shift)
uint64_t pa_index(uint64_t pa)
{
	return atop(pa - kread64(ksym(KSYMBOL_vm_first_phys)));
}

uint64_t pai_to_pvh(uint64_t pai)
{
	return kread64(ksym(KSYMBOL_pv_head_table)) + (pai * 8);
}

uint64_t pvh_ptd(uint64_t pvh)
{
	return ((kread64(pvh) & PVH_LIST_MASK) | PVH_HIGH_FLAGS);
}