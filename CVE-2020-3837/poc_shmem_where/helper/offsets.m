//
//  offsets.c
//  kfd
//
//  Created by Seo Hyun-gyu on 2023/07/29.
//

#include "offsets.h"
#include <stdint.h>
#include <UIKit/UIKit.h>
#include <Foundation/Foundation.h>

extern uint64_t kbase;

#define SYSTEM_VERSION_EQUAL_TO(v)                  ([[[UIDevice currentDevice] systemVersion] compare:v options:NSNumericSearch] == NSOrderedSame)
#define SYSTEM_VERSION_GREATER_THAN(v)              ([[[UIDevice currentDevice] systemVersion] compare:v options:NSNumericSearch] == NSOrderedDescending)
#define SYSTEM_VERSION_GREATER_THAN_OR_EQUAL_TO(v)  ([[[UIDevice currentDevice] systemVersion] compare:v options:NSNumericSearch] != NSOrderedAscending)
#define SYSTEM_VERSION_LESS_THAN(v)                 ([[[UIDevice currentDevice] systemVersion] compare:v options:NSNumericSearch] == NSOrderedAscending)
#define SYSTEM_VERSION_LESS_THAN_OR_EQUAL_TO(v)     ([[[UIDevice currentDevice] systemVersion] compare:v options:NSNumericSearch] != NSOrderedDescending)

uint64_t *symbols = NULL;
uint64_t kaslr_slide = 0;

uint64_t ksymbols_iphone_8_16a404[] = {
    0xFFFFFFF00766A0D8, // KSYMBOL_KERNPROC v
    0xFFFFFFF0070B96E8, // KSYMBOL_gPhysBase v
    0xFFFFFFF0070B9700, // KSYMBOL_gPhysSize v
    0xFFFFFFF0070B96F0, // KSYMBOL_gVirtBase v
    0xFFFFFFF0070B9840, // KSYMBOL_ptov_table v
    0xFFFFFFF007203254, // KSYMBOL_phystokv v
    0xFFFFFFF0071F68A0, // KSYMBOL_kvtophys v
    0xFFFFFFF0070B94A8, // KSYMBOL_vm_first_phys    xref aPmapEnterOverU v
    0xFFFFFFF0070B94F0, // KSYMBOL_pv_head_table v
    0xFFFFFFF0072047D4, // KSYMBOL_ml_phys_read_data v
    0xFFFFFFF0076DC0B0, // KSYMBOL_gIOKitPageableSpace v
    0xFFFFFFF0071F8EF4, // KSYMBOL_pmap_find_phys v
};

uint64_t ksym(enum ksymbol sym)
{
    kaslr_slide = kbase - 0xFFFFFFF007004000;

    return symbols[sym] + kaslr_slide;
}

uint32_t off_ipc_port_ip_kobject = 0;
uint32_t off_task_itk_space = 0;
uint32_t off_ipc_space_is_table = 0;
uint32_t off_p_pid = 0;
uint32_t off_p_pfd = 0;
uint32_t off_p_list_le_prev = 0;
uint32_t off_p_task = 0;
uint32_t off_p_name = 0;
uint32_t off_fg_data = 0;
uint32_t off_fp_fglob = 0;
uint32_t off_pb_buffer = 0;
uint32_t off_task_map = 0;
uint32_t off_vm_map_pmap = 0;
uint32_t off_pmap_ttep = 0;
uint32_t off_pmap_type = 0;
uint32_t off_pt_desc_pmap = 0;
uint32_t off_pt_desc_ptd_info = 0;

void offsets_init(void) {
    if (!(SYSTEM_VERSION_EQUAL_TO(@"12.0.1"))) {
        printf("[-] Only supported offset for iOS 12.0.1\n");
        exit(EXIT_FAILURE);
    }
    
    if (SYSTEM_VERSION_EQUAL_TO(@"12.0.1")) {
        printf("[i] offsets selected for iOS 12.0.1\n");

        off_ipc_port_ip_kobject = 0x68; //v
        off_task_itk_space = 0x300; //v
        off_ipc_space_is_table = 0x20;  //v

        off_p_pid = 0x60;   //v
        off_p_pfd = 0x100;  //v

        off_p_list_le_prev = 0x8;   //v

        off_p_task = 0x10;  //v
        off_p_name = 0x261; //v

        off_fg_data = 0x38; //v
        off_fp_fglob = 0x8; //v

        //https://github.com/apple-oss-distributions/xnu/blob/rel/xnu-4903/bsd/sys/pipe.h#L102
        // (lldb) p/x offsetof(struct pipebuf, buffer)
        // (unsigned long) 0x0000000000000010
        off_pb_buffer = 0x10;   //v

        off_task_map = 0x20;    //v

        off_vm_map_pmap = 0x48; //v

        //https://github.com/apple-oss-distributions/xnu/blob/xnu-4903.221.2/osfmk/arm/pmap.h#L302
        off_pmap_ttep = 0x8;    //v

        //Xref string: pmap_trim_internal
        off_pmap_type = 0x102;   //v A11 = 0x102

        //https://github.com/apple-oss-distributions/xnu/blob/xnu-7195.81.3/osfmk/arm/pmap.c#L1031
        off_pt_desc_pmap = 0x10+4;  //?
        off_pt_desc_ptd_info = off_pt_desc_pmap + (/*kconstant(PT_INDEX_MAX)*/ 1 * sizeof(uint64_t));

        symbols = ksymbols_iphone_8_16a404;
    }
}