#include <stdio.h>
#include <mach/mach.h>
#include <sys/mman.h>
#include <stdbool.h>

#include "iokit.h"

struct IOAccelDeviceShmemData {
    void *data;
    uint32_t length;
    uint32_t shmem_id;
};

struct IOAccelCommandQueueSubmitArgs_Header {
    uint32_t field_0;
    uint32_t count;
};

struct IOAccelCommandQueueSubmitArgs_Command {
    uint32_t command_buffer_shmem_id;
    uint32_t segment_list_shmem_id;
    uint64_t notify_1;
    uint64_t notify_2;
};

struct IOAccelSegmentListHeader {
    uint32_t field_0;
    uint32_t field_4;
    uint32_t segment_count;
    uint32_t length;
};

struct IOAccelSegmentResourceList_ResourceGroup {
    uint32_t resource_id[6];
    uint8_t field_18[48];
    uint16_t resource_flags[6];
    uint8_t field_54[2];
    uint16_t resource_count;
};

struct IOAccelSegmentResourceListHeader {
    uint64_t field_0;
    uint32_t kernel_commands_start_offset;
    uint32_t kernel_commands_end_offset;
    int total_resources;
    uint32_t resource_group_count;
    struct IOAccelSegmentResourceList_ResourceGroup resource_groups[];
};

struct IOAccelKernelCommand {
    uint32_t type;
    uint32_t size;
};

struct IOAccelKernelCommand_CollectTimeStamp {
    struct IOAccelKernelCommand command;
    uint64_t timestamp;
};


/*
com.apple.iokit.IOAcceleratorFamily:__text:FFFFFFF006CF9D80 __ZN22IOGraphicsAccelerator213newUserClientEP4taskPvjPP12IOUserClient
__int64 __fastcall IOGraphicsAccelerator2::newUserClient(
        struct_a1 *a1,
        task *a2,
        __int64 securityID,
        __int64 type,
        IOUserClient **a5) {
...
  switch ( (int)type )
  ...
    case 2:                                     // kIOAccelContext2Type
      v20 = ((__int64 (__fastcall *)(struct_a1 *))a1->IOGA2_vt->field_688)(a1);// sub_FFFFFFF006D0F980
      v19 = (IOUserClient *)v20;
      if ( v20 )
      {
        if ( IOAccelContext2::init(v20, 0, a2) )
          goto LABEL_17;
        goto LABEL_22;
      }
      break;
...
   case 5:                                     // kIOAccelDevice2Type
      v22 = a1->IOGA2_vt->__ZN22IOGraphicsAccelerator29newDeviceEv((IOGraphicsAccelerator2 *)a1);
      v19 = (IOUserClient *)v22;
      if ( v22 )
      {
        if ( !IOAccelDevice2::init(v22, 0, a2) )
          goto LABEL_22;
        goto LABEL_26;
      }
*/
#define kIOAccelContext2Type 2
#define kIOAccelDevice2Type 5


/*
com.apple.iokit.IOAcceleratorFamily:__text:FFFFFFF006CFE888 __ZN20IOAccelCommandQueue214externalMethodEjP25IOExternalMethodArgumentsP24IOExternalMethodDispatchP8OSObjectPv
__int64 __fastcall IOAccelCommandQueue2::externalMethod(
        __int64 a1,
        uint32_t a2,
        IOExternalMethodArguments *a3,
        IOExternalMethodDispatch *a4,
        OSObject *a5,
        void *a6)
{
...
    a4 = (IOExternalMethodDispatch *)&IOAccelCommandQueue2::sCommandQueueMethods[3 * a2]; 
...

com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDC070 __ZN20IOAccelCommandQueue220sCommandQueueMethodsE DCQ __ZN20IOAccelCommandQueue223s_set_notification_portEPS_PvP25IOExternalMethodArguments
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDC070                                         ; DATA XREF: IOAccelCommandQueue2::externalMethod(uint,IOExternalMethodArguments *,IOExternalMethodDispatch *,OSObject *,void *)+8↑o
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDC070                                         ; IOAccelCommandQueue2::s_set_notification_port(IOAccelCommandQueue2*,void *,IOExternalMethodArguments *)
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDC078                 DCQ 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDC080                 DCQ 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDC088                 DCQ __ZN20IOAccelCommandQueue224s_submit_command_buffersEPS_PvP25IOExternalMethodArguments ; IOAccelCommandQueue2::s_submit_command_buffers(IOAccelCommandQueue2*,void *,IOExternalMethodArguments *)
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDC090                 DCQ 0xFFFFFFFF00000000
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDC098                 DCQ 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDC0A0                 DCQ __ZN20IOAccelCommandQueue229s_set_priority_and_backgroundEPS_PvP25IOExternalMethodArguments ; IOAccelCommandQueue2::s_set_priority_and_background(IOAccelCommandQueue2*,void *,IOExternalMethodArguments *)
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDC0A8                 DCQ 0xC00000000
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDC0B0                 DCQ 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDC0B8                 DCQ __ZN20IOAccelCommandQueue224s_get_command_queue_infoEPS_PvP25IOExternalMethodArguments ; IOAccelCommandQueue2::s_get_command_queue_info(IOAccelCommandQueue2*,void *,IOExternalMethodArguments *)
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDC0C0                 DCQ 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDC0C8                 DCQ 0x800000000
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDC0D0                 DCQ __ZN20IOAccelCommandQueue224s_set_quality_of_serviceEPS_PvP25IOExternalMethodArguments ; IOAccelCommandQueue2::s_set_quality_of_service(IOAccelCommandQueue2*,void *,IOExternalMethodArguments *)
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDC0D8                 DCQ 0x800000000
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDC0E0                 DCQ 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDC0E8                 DCQ __ZN20IOAccelCommandQueue214s_set_get_infoEPS_PvP25IOExternalMethodArguments ; IOAccelCommandQueue2::s_set_get_info(IOAccelCommandQueue2*,void *,IOExternalMethodArguments *)
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDC0F0                 DCQ 0x40800000000
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDC0F8                 DCQ 0x800000000
*/
#define IOAccelCommandQueue2_set_notification_port_selector 0
#define IOAccelCommandQueue2_submit_command_buffers_selector 1

/*
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA928 ; IOAccelSharedUserClient2::sSharedMethods
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA928 __ZN24IOAccelSharedUserClient214sSharedMethodsE DCQ 0                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA928                                         ; DATA XREF: IOAccelSharedUserClient2::sharedStart(void)+40↑o
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA930                 DCQ __ZN24IOAccelSharedUserClient212new_resourceEP22IOAccelNewResourceArgsP28IOAccelNewResourceReturnDatayPj; 0 ; __ZN24IOAccelSharedUserClient212new_resourceEP22IOAccelNewResourceArgsP28IOAccelNewResourceReturnDatayPj
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA938                 DCQ 0                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA940                 DCQ 3                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA948                 DCQ 0xFFFFFFFF          ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA950                 DCQ 0xFFFFFFFF          ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA958                 DCQ 0                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA960                 DCQ __ZN24IOAccelSharedUserClient215delete_resourceEj; 0 ; __ZN24IOAccelSharedUserClient215delete_resourceEj
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA968                 DCQ 0                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA970                 DCQ 0                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA978                 DCQ 1                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA980                 DCQ 0                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA988                 DCQ 0                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA990                 DCQ __ZN24IOAccelSharedUserClient217page_off_resourceEP32IOAccelSharedPageoffResourceArgs; 0 ; __ZN24IOAccelSharedUserClient217page_off_resourceEP32IOAccelSharedPageoffResourceArgs
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA998                 DCQ 0                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA9A0                 DCQ 4                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA9A8                 DCQ 0                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA9B0                 DCQ 8                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA9B8                 DCQ 0                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA9C0                 DCQ __ZN24IOAccelSharedUserClient219finish_object_eventEjj; 0 ; __ZN24IOAccelSharedUserClient219finish_object_eventEjj
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA9C8                 DCQ 0                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA9D0                 DCQ 0                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA9D8                 DCQ 2                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA9E0                 DCQ 0                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA9E8                 DCQ 0                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA9F0                 DCQ __ZN24IOAccelSharedUserClient222set_resource_purgeableEj25eIOAccelResourcePurgeablePS0_; 0 ; __ZN24IOAccelSharedUserClient222set_resource_purgeableEj25eIOAccelResourcePurgeablePS0_
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDA9F8                 DCQ 0                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDAA00                 DCQ 0                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDAA08                 DCQ 2                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDAA10                 DCQ 1                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDAA18                 DCQ 0                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDAA20                 DCQ __ZN24IOAccelSharedUserClient212create_shmemEjP22IOAccelDeviceShmemData; 0 ; __ZN24IOAccelSharedUserClient212create_shmemEjP22IOAccelDeviceShmemData
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDAA28                 DCQ 0                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDAA30                 DCQ 2                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDAA38                 DCQ 1                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDAA40                 DCQ 0x10                ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDAA48                 DCQ 0                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDAA50                 DCQ __ZN24IOAccelSharedUserClient213destroy_shmemEj; 0 ; __ZN24IOAccelSharedUserClient213destroy_shmemEj
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDAA58                 DCQ 0                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDAA60                 DCQ 0                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDAA68                 DCQ 1                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDAA70                 DCQ 0                   ; 0
com.apple.iokit.IOAcceleratorFamily:__const:FFFFFFF006FDAA78                 DCQ 0 
*/
#define IOAccelSharedUserClient2_create_shmem_selector 5
#define IOAccelSharedUserClient2_destroy_shmem_selector 6



int IOAccelerator_init(void);
void IOAccelerator_deinit(void);
kern_return_t IOAccelCommandQueue2_set_notification_port(mach_port_t notification_port);
kern_return_t IOAccelCommandQueue2_submit_command_buffers(const struct IOAccelCommandQueueSubmitArgs_Header *submit_args, size_t size);
kern_return_t IOAccelSharedUserClient2_create_shmem(size_t size, struct IOAccelDeviceShmemData *shmem);

int alloc_shmem(uint32_t buffer_size, struct IOAccelDeviceShmemData *cmdbuf, struct IOAccelDeviceShmemData *seglist);
int alloc_shmem_with_sig(uint32_t buffer_size, struct IOAccelDeviceShmemData *cmdbuf, struct IOAccelDeviceShmemData *seglist, uint64_t command_buffer_shmem_sig, uint64_t segment_list_shmem_sig);