#include <stdio.h>
#include <sys/mman.h>
#include <unistd.h>
#include <errno.h>
#include <stdlib.h>
#include <errno.h>
#include <stdbool.h>
#include <fcntl.h>
#include <sys/stat.h>

extern int mremap_encrypted(void*, size_t, uint32_t, uint32_t, uint32_t);

static uint8_t*
map(const char *path, bool _mutable, size_t *size, int *descriptor)
{
    int f = open(path, _mutable ? O_CREAT | O_TRUNC | O_RDWR : O_RDONLY, 0755);
    if (f < 0) {
        perror(_mutable ? "open(map-ro)" : "open(map-rw)");
        return NULL;
    }
    
    if (_mutable) {
        if (ftruncate(f, *size) < 0) {
            perror("ftruncate(map)");
            return NULL;
        }
    }

    struct stat s;
    if (fstat(f, &s) < 0) {
        perror("fstat(map)");
        close(f);
        return NULL;
    }

    uint8_t *base = (uint8_t *)mmap(NULL, s.st_size, _mutable ? PROT_READ | PROT_WRITE : PROT_READ,
        _mutable ? MAP_SHARED : MAP_PRIVATE, f, 0);
    if (base == MAP_FAILED) {
        perror(_mutable ? "mmap(map-ro)" : "mmap(map-rw)");
        close(f);
        return NULL;
    }

    *size = s.st_size;
    if (descriptor) {
        *descriptor = f;
    } else {
        close(f);
    }
    return base;
}

void hexdump(const void* data, size_t size) {
    char ascii[17];
    size_t i, j;
    ascii[16] = '\0';
    for (i = 0; i < size; ++i) {
        if ((i % 16) == 0)
        {
            printf("[0x%016llx+0x%03zx] ", &data, i);
        }

        printf("%02X ", ((unsigned char*)data)[i]);
        if (((unsigned char*)data)[i] >= ' ' && ((unsigned char*)data)[i] <= '~') {
            ascii[i % 16] = ((unsigned char*)data)[i];
        }
        else
            ascii[i % 16] = '.';

        if ((i + 1) % 8 == 0 || i + 1 == size) {
            printf(" ");
            if ((i + 1) % 16 == 0)
                printf("|  %s \n", ascii);
            else if (i + 1 == size) {
                ascii[(i + 1) % 16] = '\0';
                if ((i + 1) % 16 <= 8) {
                    printf(" ");
                }
                for (j = (i + 1) % 16; j < 16; ++j)
                    printf("   ");

                printf("|  %s \n", ascii);
            }
        }
    }
}

int main(int argc, char *argv[], char *envp[]) {

    // file create with 0x24 0x24 0x00 .... data
    const char* filepath = "/Users/seo/file.bin";
    int fd = open(filepath, O_CREAT | O_WRONLY | O_TRUNC, 0644);
    if (fd < 0) return 1;

    unsigned char buf[0x4000] = {0};
    buf[0] = 0;
    buf[1] = 0;

    write(fd, buf, sizeof(buf));
    close(fd);

	size_t base_size;
    uint8_t *base = map(filepath, false, &base_size, &fd);
	printf("fd = %d, base_size = 0x%x, base = %p\n", fd, base_size, base);
	printf("errno = %d\n", errno);

	void *inMap = mmap(0, 0x4000, PROT_READ | PROT_EXEC, MAP_SHARED, fd, 0);
	printf("inMap = %p, errnp2 = %d\n", inMap, errno);
	hexdump(inMap, 0x20);
	printf("errno3 = %d\n", errno);

	int ret = mremap_encrypted(inMap, 0x10, 0x10, 0x100000C, 0);	//cryptbase, info->cryptsize, info->cryptid, cpuType, cpuSubType
	printf("mremap_encrypted(cryptid = com.apple.null) ret = %d, errno4 = %d\n", ret, errno); 
	hexdump(inMap, 0x20);

	return 0;
}