import sys
import re

# 1. 요청하신 변수 선언
IOUserIterator_kobj = 0xffffff

def extract_strings(filename, min_len=4):
    """
    바이너리 파일에서 min_len 길이 이상의 출력 가능한 ASCII 문자열을 추출하여 set으로 반환
    """
    try:
        with open(filename, 'rb') as f:
            data = f.read()
            # 정규표현식: 4글자 이상의 출력 가능한 문자(ASCII 0x20~0x7E) 패턴 찾기
            # 바이트(rb) 모드로 검색
            pattern = rb"[ -~]{%d,}" % min_len
            found = set(re.findall(pattern, data))
            return found
    except FileNotFoundError:
        print(f"[!] 파일을 찾을 수 없습니다: {filename}")
        sys.exit(1)

def main():
    if len(sys.argv) < 3:
        print(f"사용법: python3 {sys.argv[0]} <파일1> <파일2>")
        print("예시: python3 search.py dump1.bin dump2.bin")
        return

    file1_path = sys.argv[1]
    file2_path = sys.argv[2]

    print(f"[*] '{file1_path}'에서 문자열 추출 중...")
    strs1 = extract_strings(file1_path)
    
    print(f"[*] '{file2_path}'에서 문자열 추출 중...")
    strs2 = extract_strings(file2_path)

    # 교집합(공통 문자열) 구하기
    common = strs1.intersection(strs2)

    print(f"[*] 두 파일에 모두 존재하는 문자열 개수: {len(common)}")
    print("-" * 40)
    
    for s in common:
        try:
            # 바이트를 문자열로 디코딩하여 출력
            if("cpp_obj_ptr = " in s.decode('utf-8')):
                print(s.decode('utf-8'))
        except UnicodeDecodeError:
            continue

if __name__ == "__main__":
    main()