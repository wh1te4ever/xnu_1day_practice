#include <errno.h>
#include <mach/mach.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/sysctl.h>
#include <sys/syscall.h>
#include <unistd.h>
#include <stdbool.h>

#include "xnuspy_ctl.h"

uint64_t kernel_slide = 0;

static void (*_bzero)(void *p, size_t n);
static int (*copyinstr)(const void *uaddr, void *kaddr, size_t len, size_t *done);
static void *(*current_proc)(void);
static void (*kprintf)(const char *, ...);
static void (*proc_name)(int pid, char *buf, int size);
static pid_t (*proc_pid)(void *);
static int (*_strcmp)(const char *s1, const char *s2);
static void *(*unified_kalloc)(size_t sz);
static void (*unified_kfree)(void *ptr);

static long SYS_xnuspy_ctl = 0;

static int gather_kernel_offsets(void){
    int ret;
#define GET(a, b) \
    do { \
        ret = syscall(SYS_xnuspy_ctl, XNUSPY_CACHE_READ, a, b, 0); \
        if(ret){ \
            printf("%s: failed getting %s\n", __func__, #a); \
            return ret; \
        } \
    } while (0)

    GET(BZERO, &_bzero);
    GET(COPYINSTR, &copyinstr);
    GET(CURRENT_PROC, &current_proc);
    GET(KPRINTF, &kprintf);
    GET(PROC_NAME, &proc_name);
    GET(PROC_PID, &proc_pid);
    GET(STRCMP, &_strcmp);
    GET(UNIFIED_KALLOC, &unified_kalloc);
    GET(UNIFIED_KFREE, &unified_kfree);

    return 0;
}

/*
struct kalloc_result
kalloc_ext(
	kalloc_heap_t         kheap, -> void*
	vm_size_t             req_size, -> uint64_t
	zalloc_flags_t        flags, -> uint64_t
	vm_allocation_site_t  *site) -> uint64_t
*/


struct kalloc_result {
	void         *addr;
	vm_size_t     size;
};

// hook kalloc_ext
static struct kalloc_result (*kalloc_ext_orig)(uint64_t, uint64_t, uint64_t, uint64_t);

static struct kalloc_result kalloc_ext_replaced(uint64_t kheap, uint64_t req_size, uint64_t flags, uint64_t site){
    struct kalloc_result kret = kalloc_ext_orig(kheap, req_size, flags, site);
    uint64_t caller = (uint64_t)(__builtin_return_address(0) - kernel_slide);

    if(1) {
        if((kheap-kernel_slide) == 0xFFFFFFF0070FAD58 && req_size >= 513)  //Is KHEAP_DEFAULT?
        {
            // kprintf("[kernhook] kalloc_ext kret: 0x%llx\n", kret);
            kprintf("[kernhook] kalloc_ext caller: 0x%llx\n", (__builtin_return_address(0) - kernel_slide));
            kprintf("[kernhook] kalloc_ext[KHEAP_DEFAULT] req_size: 0x%llx, kptr = 0x%llx\n", req_size, kret);
        }

        // if((kheap-kernel_slide) == 0xFFFFFFF0070FB350 && req_size >= 500)  //Is KHEAP_DATA_BUFFERS?
        // {
        //     kprintf("[kernhook] kalloc_ext caller: 0x%llx\n", (__builtin_return_address(0) - kernel_slide));
        //     kprintf("[kernhook] kalloc_ext[KHEAP_DATA_BUFFERS] req_size: 0x%llx, kptr = 0x%llx\n", req_size, kret);
        // }


        if((kheap-kernel_slide) == 0xFFFFFFF0070FB828 && req_size >= 513)  //Is KHEAP_KEXT?
        {
            kprintf("[kernhook] kalloc_ext caller: 0x%llx\n", (__builtin_return_address(0) - kernel_slide));
            kprintf("[kernhook] kalloc_ext[KHEAP_KEXT] req_size: 0x%llx, kptr = 0x%llx\n", req_size, kret);
        }
    }

    return kret;
}


int hook_kalloc_ext(void) {
    uint64_t func = 0xFFFFFFF0071C59E8;

    int ret = syscall(SYS_xnuspy_ctl, XNUSPY_INSTALL_HOOK,
            func, kalloc_ext_replaced, &kalloc_ext_orig);
	
	printf("XNUSPY_INSTALL_HOOK(hook_kalloc_ext) ret = %d\n", ret);

    return ret;
}

// hook AGXShared::create_mtllateevalevent
static uint64_t (*create_mtllateevalevent_orig)(uint64_t, uint64_t);

static uint64_t create_mtllateevalevent_replaced(uint64_t AGXShared, uint64_t a2){
    uint64_t kret = create_mtllateevalevent_orig(AGXShared, a2);
    uint64_t caller = (uint64_t)(__builtin_return_address(0) - kernel_slide);

    kprintf("[kernhook] create_mtllateevalevent caller: 0x%llx\n", (__builtin_return_address(0) - kernel_slide));
    kprintf("[kernhook] create_mtllateevalevent kret = 0x%llx, AGXShared = 0x%llx, a2 = 0x%llx, caller = 0x%llx\n", kret, AGXShared, a2, (__builtin_return_address(0) - kernel_slide));

    return kret;
}

int hook_AGXShared_create_mtllateevalevent(void) {
    uint64_t func = 0xFFFFFFF005DC4FC0;

    int ret = syscall(SYS_xnuspy_ctl, XNUSPY_INSTALL_HOOK,
            func, create_mtllateevalevent_replaced, &create_mtllateevalevent_orig);

    printf("XNUSPY_INSTALL_HOOK(hook_AGXShared_create_mtllateevalevent) ret = %d\n", ret);

    return ret;
}

// hook AGXFirmwareResourceStack<unsigned long long,AGXLateEvalEvent>::growResourceStack(unsigned __int64 *a1);
// __ZN24AGXFirmwareResourceStackIy16AGXLateEvalEventE17growResourceStackEv
static uint64_t (*growResourceStack_orig)(uint64_t);

static uint64_t growResourceStack_replaced(uint64_t AGXFirmwareResourceStack){
    uint64_t kret = growResourceStack_orig(AGXFirmwareResourceStack);
    uint64_t caller = (uint64_t)(__builtin_return_address(0) - kernel_slide);

    kprintf("[kernhook] growResourceStack caller: 0x%llx\n", (__builtin_return_address(0) - kernel_slide));
    kprintf("[kernhook] growResourceStack kret = 0x%llx, AGXFirmwareResourceStack = 0x%llx, caller = 0x%llx\n", kret, AGXFirmwareResourceStack, (__builtin_return_address(0) - kernel_slide));

    return kret;
}

int hook_AGXFirmwareResourceStack_growResourceStack(void) {
    uint64_t func = 0xFFFFFFF005DA4644;

    int ret = syscall(SYS_xnuspy_ctl, XNUSPY_INSTALL_HOOK,
            func, growResourceStack_replaced, &growResourceStack_orig);

    printf("XNUSPY_INSTALL_HOOK(hook_AGXFirmwareResourceStack_growResourceStack) ret = %d\n", ret);

    return ret;
}

// hook AGXFirmwareResourceStack<unsigned long long,AGXLateEvalEvent>::replaceStorageArrays(__int64 a1, unsigned int a2)
// __ZN24AGXFirmwareResourceStackIy16AGXLateEvalEventE20replaceStorageArraysEj
static uint64_t (*replaceStorageArrays_orig)(uint64_t, uint64_t);

static uint64_t replaceStorageArrays_replaced(uint64_t AGXFirmwareResourceStack, uint64_t a2){
    uint64_t kret = replaceStorageArrays_orig(AGXFirmwareResourceStack, a2);
    uint64_t caller = (uint64_t)(__builtin_return_address(0) - kernel_slide);

    kprintf("[kernhook] replaceStorageArrays kret = 0x%llx, AGXFirmwareResourceStack = 0x%llx, a2 = 0x%llx, caller = 0x%llx\n", kret, AGXFirmwareResourceStack, a2, (__builtin_return_address(0) - kernel_slide));

    return kret;
}

int hook_AGXFirmwareResourceStack_replaceStorageArrays(void) {
    uint64_t func = 0xFFFFFFF005DA53EC;

    int ret = syscall(SYS_xnuspy_ctl, XNUSPY_INSTALL_HOOK,
            func, replaceStorageArrays_replaced, &replaceStorageArrays_orig);

    printf("XNUSPY_INSTALL_HOOK(hook_AGXFirmwareResourceStack_replaceStorageArrays) ret = %d\n", ret);

    return ret;
}

// hook _IOMalloc_external
static uint64_t (*IOMalloc_external_orig)(uint64_t);

static uint64_t IOMalloc_external_replaced(uint64_t size){
    uint64_t kret = IOMalloc_external_orig(size);
    uint64_t caller = (uint64_t)(__builtin_return_address(0) - kernel_slide);

    //parse only caller is from AGXFirmwareResourceStack<ulong long,AGXLateEvalEvent>::replaceStorageArrays
    if(caller == 0xFFFFFFF005DA5440) {
        kprintf("[kernhook] IOMalloc_external caller: 0x%llx\n", (__builtin_return_address(0) - kernel_slide));
        kprintf("[kernhook] IOMalloc_external kret = 0x%llx, sz = 0x%llx\n", kret, size);
        return kret;
    }

    // if(size == 576) {
    //     kprintf("[kernhook] IOMalloc_external caller: 0x%llx\n", (__builtin_return_address(0) - kernel_slide));
    //     kprintf("[kernhook] IOMalloc_external kret = 0x%llx, sz = 0x%llx, caller = 0x%llx\n", kret, size, (__builtin_return_address(0) - kernel_slide));
    //     return kret;
    // }

    return kret;
}

int hook_IOMalloc_external(void) {
    uint64_t func = 0xFFFFFFF007729F10;

    int ret = syscall(SYS_xnuspy_ctl, XNUSPY_INSTALL_HOOK,
            func, IOMalloc_external_replaced, &IOMalloc_external_orig);

    printf("XNUSPY_INSTALL_HOOK(hook_IOMalloc_external) ret = %d\n", ret);

    return ret;
}


// hook panic_trap_to_debugger
static uint64_t (*panic_trap_to_debugger_orig)(const char *panic_format_str, va_list *panic_args, unsigned int reason, void *ctx, uint64_t panic_options_mask, void *panic_data_ptr, unsigned long panic_caller);

static uint64_t panic_trap_to_debugger_replaced(const char *panic_format_str, va_list *panic_args, unsigned int reason, void *ctx, uint64_t panic_options_mask, void *panic_data_ptr, unsigned long panic_caller){
    kprintf("[kernhook] panic_trap_to_debugger called due to panic, spinning here for a little bit...\n");
    uint64_t i = 0;
    while(1) {
        i++;
        if(i > 0x30000000) break;
    }
    return panic_trap_to_debugger_orig(panic_format_str, panic_args, reason, ctx, panic_options_mask, panic_data_ptr, panic_caller);
}

int hook_panic_trap_to_debugger(void) {
    uint64_t func = 0xFFFFFFF0071B7B30;

    int ret = syscall(SYS_xnuspy_ctl, XNUSPY_INSTALL_HOOK,
            func, panic_trap_to_debugger_replaced, &panic_trap_to_debugger_orig);

    printf("XNUSPY_INSTALL_HOOK(hook_panic_trap_to_debugger) ret = %d\n", ret);

    return ret;
}

bool install_kernel_hook(void){
    size_t oldlen = sizeof(long);
    int res = sysctlbyname("kern.xnuspy_ctl_callnum", &SYS_xnuspy_ctl,
            &oldlen, NULL, 0);

    if(res == -1){
        printf("sysctlbyname with kern.xnuspy_ctl_callnum failed: %s\n",
                strerror(errno));
        return false;
    }

    res = syscall(SYS_xnuspy_ctl, XNUSPY_CHECK_IF_PATCHED, 0, 0, 0);

    if(res != 999){
        printf("xnuspy_ctl isn't present?\n");
        return false;
    }

	res = gather_kernel_offsets();

    if(res){
        printf("something failed: %s\n", strerror(errno));
        return 1;
    }

    res = syscall(SYS_xnuspy_ctl, XNUSPY_CACHE_READ, KERNEL_SLIDE,
            &kernel_slide, 0, 0);
    if(res){
        printf("failed reading kernel slide from xnuspy cache\n");
        return false;
    }
	printf("kernel_slide = 0x%llx\n", kernel_slide);

    /* iPad 7th gen, 15.0 */
    // hook_kalloc_ext();
    hook_AGXShared_create_mtllateevalevent();
    hook_AGXFirmwareResourceStack_growResourceStack();
    hook_AGXFirmwareResourceStack_replaceStorageArrays();
    hook_IOMalloc_external();
    hook_panic_trap_to_debugger();


    return true;
}

int main(int argc, char **argv){

	install_kernel_hook();

	while(1) {};

    return 0;
}