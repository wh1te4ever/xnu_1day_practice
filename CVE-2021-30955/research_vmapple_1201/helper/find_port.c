#include "find_port.h"
#include "offsets.h"
#include "kextrw.h"
#include "proc.h"
#include <stdio.h>

uint64_t find_port(mach_port_name_t port) {
    uint64_t task_addr = task_self_addr();

    uint64_t itk_space = kextrw_kread64(task_addr + off_task_itk_space);
    itk_space = xpaci(itk_space);
    
    uint64_t is_table = kextrw_kread64(itk_space + off_ipc_space_is_table);
    is_table = xpaci(is_table);
    
    uint32_t port_index = port >> 8;
    const int sizeof_ipc_entry_t = 0x18;
    
    uint64_t port_addr = kextrw_kread64(is_table + (port_index * sizeof_ipc_entry_t));
    port_addr = xpaci(port_addr);
    return port_addr;
}

uint64_t find_oolports_from_port(mach_port_name_t port) {
    uint64_t port_kaddr = find_port(port);

    uint32_t off_ipc_port_ikmq_base = 0x30;
    uint64_t ikmq_base = kextrw_kread64(port_kaddr + off_ipc_port_ikmq_base);
    // INFO("ikmq_base: 0x%llx\n", ikmq_base);

    uint32_t off_ipc_kmsg_ikm_header = 0x18; // p/x offsetof(struct ipc_kmsg, ikm_header)
    uint64_t ikm_header = kextrw_kread64(ikmq_base+off_ipc_kmsg_ikm_header);

    uint64_t off_mach_msg_ool_ports_desc_address = 0x24; //?
    return kextrw_kread64(ikm_header + off_mach_msg_ool_ports_desc_address);
}

uint64_t find_kmsgdata_from_port(mach_port_name_t port) {
    uint64_t port_kaddr = find_port(port);

    uint32_t off_ipc_port_ikmq_base = 0x30;
    uint64_t ikmq_base = kextrw_kread64(port_kaddr + off_ipc_port_ikmq_base);

    uint32_t off_ipc_kmsg_ikm_header = 0x18; // p/x offsetof(struct ipc_kmsg, ikm_header)
    uint64_t ikm_header = kextrw_kread64(ikmq_base+off_ipc_kmsg_ikm_header);

    return (ikm_header);
}

uint64_t port_to_kobject(mach_port_t port)
{
    uint64_t ipc_port = find_port(port);
    uint64_t kobject = kextrw_kread64(ipc_port + 0x58);    // 0x58 = p/x offsetof(ipc_port, kdata.kobject)
    return kobject;
} 