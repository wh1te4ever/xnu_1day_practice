#include "find_pipe.h"
#include "tfp0_krw.h"
#include "proc.h"
#include "offsets.h"

int obtain_pipe_kaddr(int rfd) {
	
	uint64_t p_fd = tfp0_kread64(proc_of_pid(getpid()) + off_p_pfd); 
	printf("p_fd = 0x%llx\n", p_fd);

	uint64_t rpipe_fp = tfp0_kread64(p_fd + rfd * 8);
    printf("pipe_fp = 0x%llx\n", rpipe_fp);

	uint64_t r_fp_glob = tfp0_kread64(rpipe_fp + off_fp_fglob);
    printf("fp_glob = 0x%llx\n", r_fp_glob);

	uint64_t rpipe = tfp0_kread64(r_fp_glob + off_fg_data); 
    printf("pipe = 0x%llx\n", rpipe);


	uint64_t pipe_base = tfp0_kread64(rpipe + off_pb_buffer); 
	
    return pipe_base;
}

/*
int obtain_pipes_kaddr(int *pipefds, int total_pipes) {
	
	uint64_t p_fd = tfp0_kread64(proc_of_pid(getpid()) + off_p_pfd); 
	printf("p_fd = 0x%llx\n", p_fd);;
	uint64_t fd_ofiles = tfp0_kread64(p_fd);
	printf("fd_ofiles = 0x%llx\n", fd_ofiles);

	uint64_t last_pipe_base = 0;

	for (int i = 0; i < total_pipes; i++) {
        int rfd = pipefds[2 * i];
		uint64_t rpipe_fp = tfp0_kread64(fd_ofiles + rfd * 8);
		uint64_t r_fp_glob = tfp0_kread64(rpipe_fp + off_fp_fglob);
		uint64_t rpipe = tfp0_kread64(r_fp_glob + off_fg_data); 
		uint64_t pipe_base = tfp0_kread64(rpipe + off_pb_buffer); 
		printf("KHEAP_DATA_BUFFERS KALLOCATED ADDR = 0x%llx\n", pipe_base);
		
		last_pipe_base = pipe_base;
	}

	printf("[!] Try setting macro KHEAP_DATA_MAPPABLE_LOC to 0x%llx\n", last_pipe_base - (0x4000*(total_pipes / 2)));

        */