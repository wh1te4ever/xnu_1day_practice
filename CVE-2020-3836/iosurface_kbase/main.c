#include <stdio.h>
#include <stdlib.h>
#include <mach/mach.h>
#include <mach/mach_time.h>
#include <sched.h> 
#include <iokernelrw.h>

#include "iokernelrw_krw.h"
#include "helper.h"

io_connect_t iokernelrw_client = MACH_PORT_NULL;

int main(int argc, char *argv[], char *envp[]) {
    iokernelrw_client = iokernelrw_open();
    printf("iokernelrw_client: 0x%llx\n", iokernelrw_client);
	if (iokernelrw_client == MACH_PORT_NULL) {
        fprintf(stderr, "[-] Failed to open IOKernelRW service.\n");
        return 1;
    }

	int ret = get_kbase(&kbase);
    printf("get_kbase ret: %d, kbase: 0x%llx, kslide: 0x%llx\n", ret, kbase, kslide);

    uint64_t kext_addr = find_kext_address("com.apple.iokit.IOSurface");
    printf("com.apple.iokit.IOSurface kext base: 0x%llx\n", kext_addr+kslide);

    IOServiceClose(iokernelrw_client);

    return 0;
}